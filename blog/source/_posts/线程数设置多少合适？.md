
title: 线程数设置多少合适

date: 2016-05-14

categories: [Java] 

---


> 在实际开发中经常会用到线程池，而线程池中线程数的设置尤为重要。

<!--more-->

### 使用多线程的目的

假设服务器有1个线程处理用户一个请求的时间为100ms，这一个请求又分为3个互不影响的串行逻辑，处理时间为30ms、30ms和40ms，则在1s内只能处理10个请求，这意味着其他请求只能等待，这样当用户访问量非常大的时候，就会造成大量用户等待，体验很差。
假设服务器开10个线程处理用户请求，这个时候1s就可以处理100个请求，体验稍好一些。
假设用3个不同的线程去并行去处理这一个请求中的3个互不影响的逻辑，这样整个请求的处理时间就由100ms降为了40～50ms（还要考虑线程切换的耗时，这里只是假设），这时1s就可以处理100*(2~2.5)个请求。
这就是多线程的好处。

### 多线程数量设置

一个任务可以按照这个任务主要处理的内部逻辑分为IO密集型任务和计算密集型任务。
#### IO密集型任务
IO密集型任务即主要处理的为IO操作，比如文件读写、网络通信等，这种任务占用CPU资源比较少，至于为何占用的少，可以参见[这里](https://www.zhihu.com/question/27734728)，这种情况下如果没有使用多线程来处理IO密集型任务，CPU就会傻傻的等待在那里，极大浪费CPU资源，因此需设置多线程来最大化利用CPU资源。
#### IO密集型任务设置多少线程合适？
IO密集型任务占用CPU资源很少，假设一个应用里面全是IO密集型任务，则线程数＝(CPU内核数)／(1-阻塞系数)，其中阻塞系数一般为0.8～0.9。
#### 计算密集型任务
计算密集型任务即应用中处理的是算法计算等，这种任务主要通过CPU来完成，因此占用CPU资源比较多。
#### 计算密集型任务设置多少线程合适？
计算密集型任务因占用CPU资源比较多，因此为了最大化利用CPU资源，一般设置线程数＝CPU内核数*2
#### 混合型任务线程数量的设置
混合型任务即包含计算操作也包含IO操作，假设整个任务处理时间为100ms，计算操作占用时间为20ms，IO操作占用时间为80ms，也就是说CPU只有大约五分之一在被占用，其他五分之四被浪费掉，这个时候需要启动的线程数＝5，即为（计算操作占用时间＋IO操作占用时间）／计算操作占用时间。

### 补充
在以上举的例子中带有一些极端，并没有考虑到线程切换带来的时间损耗，也没有考虑到服务器IO的处理性能。具体线程数的设置还需要根据具体业务具体分析，综合各种考虑，比如：CPU、IO、内存等。

